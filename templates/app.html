<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>

    <style>
     body {
       min-height: calc(100vh - 1.0rem);
       width: max-content;
     }
     h2 {
       display: inline-block;
       margin: 0.25rem 0.0rem 0.5rem 0.0rem;
     }
     .err_dlg {
       padding: 1.1rem 1.4rem;
     }
     .err_dlg div {
       width: 22rem;
       color: #D10000;
       overflow: auto;
     }
     .err_dlg button {
       margin-top: 1.2rem;
     }
     header h2 {
       cursor: pointer;
     }
     .tourn_info p {
       margin: 0.8rem 0.0rem;
     }
     .tourn_info label {
       margin-left: 1.3rem;
     }
     .tourn_info input {
       padding: 0.15rem 0.35rem;
     }
     .tourn_info input[type="text"] {
       width: 13rem;
     }
     .tourn_info input[type="number"] {
       width: 3rem;
     }
     .tourn_info input[readonly] {
       border: thin solid grey;
       background-color: #F0F0F0;
     }
     .attn {
       background-color: #FFE4E1;
     }
     button[value^="fake_"] {
       background-color: #AFEEEE;
     }
     .login_info {
       float: right;
       text-align: right;
       padding-top: 0.60rem;
     }
     .login_info span {
       font-weight: bolder;
       color: mediumblue;
       cursor: pointer;
     }
     .view_sel {
       margin-left: 1.5rem;
       font-weight: bold;
     }
     .view_sel label {
       margin-left: 0.6rem;
       font-weight: bold;
     }
     .view_body {
       position: relative;
       width: 98vw;
       min-width: 80rem;
       max-width: 100rem;
     }
     .view_body h2 {
       position: absolute;
       z-index: 1;
       cursor: pointer;
     }
     .tbl_wrapper {
       min-height: calc(100vh - 13.5rem);
       visibility: hidden;
     }
     #view_tbl {
       margin-top: 0.3rem;
     }
     .actions {
       padding: 0.5rem 0.0rem;
       margin-top: 1.1rem;
     }
     .actions button {
       margin-right: 0.8rem;
       padding: 0.2rem 0.8rem;
     }
     .actions label {
       margin-left: 1.0rem;
       margin-right: 0.3rem;
     }
     .actions a,
     .actions span {
       margin-right: 0.5rem;
     }
     .actions .disabled {
       color: grey;
       text-decoration: underline;
       cursor: default;
     }
    </style>
    <link href="/static/datatables.min.css" rel="stylesheet">
  </head>

  <body>
    <dialog class="err_dlg">
      <div></div>
      <button autofocus>Close</button>
    </dialog>
    <header>
      {% with tooltip = "Click here to go to current stage" %}
      <h2 title='{{tooltip}}'>{{tourn.name}}</h2>
      {% endwith %}
      <span class="view_sel">
        View:
        {% for view, info in view_defs.items() %}
        {% set checked = " checked" if view == view_path else "" %}
        <label>{{info.name}}<input type="radio" name="view" value="{{view}}"{{checked}}></label>
        {% endfor %}
      </span>
      <span class="login_info">
        {% with tooltip = "Click here to enter admin mode" %}
        Logged in as: <span title='{{tooltip}}'>{{user.name}}</span>
        [<a href='/logout'>Logout</a>]
        {% endwith %}
      </span>
    </header>

    <section class="tourn_info">
      <p>
        <input name="tourn_name" type="hidden" value="{{tourn.name}}">
        <label>Players:</label>
        <input name="players" type="number" value="{{tourn.players}}" disabled>
        <label>Teams:</label>
        <input name="teams" type="number" value="{{tourn.teams}}" disabled>
        <label>THM Teams:</label>
        <input name="thm_teams" type="number" value="{{tourn.thm_teams}}" disabled>
      </p>
      <p>
        <label>Current Stage:</label>
        <input name="cur_stage" type="text" value="{{tourn.cur_stage}}" disabled>
        <label>Next:</label>
        {% set next_actn = tourn.next_action if tourn.next_action else "" %}
        <input name="next_action" type="text" value="{{next_actn}}" disabled>
      </p>
    </section>

    <section class="view_body">
      {% with tooltip = "Click here to refresh table data" %}
      <h2 title='{{tooltip}}'>{{view_info.name}}</h2>
      {% endwith %}
      <div class="tbl_wrapper">
        <table id="view_tbl" class="display" spellcheck="false">
          <thead>
            <tr>
              {% for col in view_info.layout %}
              <th>{{col[1]}}</th>
              {% endfor %}
            </tr>
          </thead>
        </table>
      </div>
      <form class="actions" action="{{view_path}}" method="post">
        {% for val in buttons %}
        <button value="{{val}}"{{btn_attr[loop.index0]}}>{{btn_lbl[loop.index0]}}</button>
        {% endfor %}
        {% if links %}
        <label>Display:</label>
        {% for lnk in links %}
        {% set lnk_enabled = (tourn.stage_compl >= lnk[2]) %}
        {% if lnk_enabled %}
        <a href="{{lnk[0]}}" target="_blank">{{lnk[1]}}</a>
        {% else %}  {# lnk_enabled #}
        <span class="disabled" data-href="{{lnk[0]}}">{{lnk[1]}}</span>
        {% endif %}  {# lnk_enabled #}
        {% endfor %}  {# lnk in links #}
        {% endif %}  {# links #}
      </form>
    </section>
  </body>

  <script src="/static/jquery-3.7.1.min.js"></script>
  <script src="/static/datatables.min.js"></script>
  <script src="/static/dataTables.scrollResize.min.js"></script>
  <script>
   $(function() {
     // add css and attributes
     $(".actions button").attr({
       type: 'submit',
       name: "submit_func"
     });

     // error dialog
     $('.err_dlg button').on('click', function() {
       $('.err_dlg')[0].close();
     });
     const show_error = function(err_text) {
       $('.err_dlg div').html(err_text);
       $('.err_dlg')[0].showModal();
     };

     // view selection
     $(".view_sel input").on('change', function() {
       const path = $(".view_sel input:checked").val();
       window.location.href = path;
     });

     // shortcuts (navigation)
     $("header h2").on('click', function() {
       window.location.href = './';
     });
     $('.view_body h2').on('click', function() {
       // NOTE: we currently refresh the page (rather than just reloading the table data),
       // since we would like to pick up stage/state changes (e.g. button enablement)
       //table.ajax.reload(null, false);
       window.location.href = "";
     });
     $('.login_info span').on('click', function() {
       window.location.href = "/tourn";
     });

     // view stuff
     const editable = function(node) {
       let orig_val;

       node.setAttribute('contenteditable', true);
       node.addEventListener('keypress', function(e) {
         if (e.which == 13) {
           e.preventDefault();
           $(this).trigger('blur');
           $(this).next('td').focus();
           //return false;
         }
       });

       node.addEventListener('focus', function(e) {
         orig_val = e.target.textContent;
         $('td[contenteditable].attn').removeClass("attn");
         window.getSelection().selectAllChildren(e.target);
       });

       node.addEventListener('blur', function(e) {
         window.getSelection().empty();
         if (e.target.textContent !== orig_val) {
           const cell = table.cell(e.target)
           const row = table.row(e.target.parentElement);
           cell.data(e.target.textContent).draw();

           const post_data = $.extend({tourn: "{{tourn.name}}"}, row.data());
           $.post('/data{{view_path}}', post_data)
            .done(function(resp) {
              console.log('POST /data{{view_path}} done: ', resp);
              if (resp.err) {
                cell.data(orig_val).draw();
                $(e.target).addClass("attn");
                show_error(resp.err);
              }
              else if (resp.succ) {
                if (resp.data == 'all') {
                  console.log('Reloading table data');
                  table.ajax.reload();
                }
                else if (resp.data) {
                  console.log('Updating row data: ', resp.data);
                  row.data(resp.data).draw();
                }
              }
            })
            .fail(function(resp) {
              console.log('POST /data{{view_path}} fail: ', resp);
              cell.data(orig_val).draw();
              $(e.target).addClass("attn");
              show_error(resp.statusText);
              win = window.open('', '_blank')
              win.document.body.innerHTML = resp.responseText;
            });
       }});
     };

     const tourn = $('.info_blk input[name="tourn_name"]').val();
     const table = $('#view_tbl').DataTable({
       rowId: '{{view_info.rowid_col}}',
       paging: false,
       scrollX: true,
       scrollY: '35.0rem',
       scrollResize: true,
       //fixedColumns: {
       //  start: {{view_info.fixed_cols}}
       //},
       columnControl: {
         target: 1,
         content: ['search']
       },
       ajax: {
         url: '/data{{view_path}}',
         dataSrc: 'data'
       },
       deferRender: true,
       columns: [
         {% for col in view_info.layout %}
         {data: '{{col[0]}}'},
         {% endfor %}
       ],
       columnDefs: [
         {% for col in view_info.layout %}
         {% if col[2] == 'hidden' %}
         {target: {{loop.index0}}, visible: false, searchable: false},
         {% elif col[2] == 'centered' %}
         {target: {{loop.index0}}, className: 'dt-center'},
         {% elif col[2] == 'editable' %}
         {target: {{loop.index0}}, createdCell: editable},
         {% else %}
         {target: {{loop.index0}}},
         {% endif %}
         {% endfor %}
       ],
       order: [
         {% for ord_col in view_info.tbl_order %}
         [{{ord_col}}, 'asc'],
         {% endfor %}
       ],
       initComplete: function(settings, json) {
         $(".tbl_wrapper").css('visibility', 'visible');
         table.columns.adjust().draw();
       }
     });

     // links for charts, dashboards, reports
     $('.actions .disabled').on('click', function() {
       //show_error("Cannot display \"" + $(this).text() + "\", data not yet available");
       return false;
     });

     // TODO: set initial focus (and/or highlight) here!!!

     {% if err_msg %}
     show_error('{{err_msg|safe}}');
     {% endif %}
   });
  </script>
</html>
