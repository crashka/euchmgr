<!DOCTYPE html>
<html>
  <head>
    <title>{{title}}</title>

    <style>
     body {
       width: max-content;
       min-width: 65rem;
     }
     form {
       overflow: hidden;
     }
     table {
       margin-top: 0.3rem;
     }
     input[readonly] {
       border: thin solid grey;
       background-color: #F0F0F0;
     }
     input[type="text"] {
       width: 12rem;
     }
     input[type="number"] {
       width: 3rem;
     }
     .attn {
       background-color: #FFE4E1;
     }
     button[value^="fake_"] {
       background-color: #AFEEEE;
     }
     .err_dlg {
       padding: 1.1rem 1.4rem;
     }
     .err_dlg div {
       width: 22rem;
       color: #D10000;
       overflow: auto;
     }
     .err_dlg button {
       margin-top: 1.2rem;
     }
     .container {
       overflow: hidden;
     }
     .section {
       margin-top: 0.5rem;
       position: relative;
     }
     .tourn_lbl {
       font-size: x-large;
       font-weight: bold;
       cursor: pointer;
     }
     .login_info {
       float: right;
       text-align: right;
       /*margin-right: 1.0rem;*/
       /*padding: 0.5rem 0.0rem;*/
     }
     .login_info span {
       font-weight: bolder;
       color: mediumblue;
       cursor: pointer;
     }
     .subsect {
       margin-top: 0.5rem;
       overflow: hidden;
     }
     .view_sel {
       margin-left: 1.5rem;
       font-weight: bold;
     }
     .view_sel label {
       margin-left: 0.6rem;
       font-weight: bold;
     }
     .view_title {
       font-size: x-large;
       font-weight: bold;
       position: absolute;
       top: 0.3rem;
       z-index: 1;
       cursor: pointer;
     }
     .info_blk {
       padding: 0.8rem 0 0.5rem 1.0rem;
     }
     .stage_blk {
       padding-left: 1.0rem;
     }
     .info_blk span,
     .stage_blk span {
       margin-right: 1.5rem;
     }
     .info_blk input {
       margin-left: 0.3rem;
       padding: 0.1rem 0.35rem;
     }
     .stage_blk input {
       margin-left: 0.3rem;
       padding: 0.1rem 0.35rem;
       width: 13rem;
     }
     .tbl_wrapper {
       display: none;
       width: 80rem;
     }
     .actions {
       clear: both;
       padding: 1.0rem 0;
     }
     .actions button {
       margin-right: 0.8rem;
       padding: 0.2rem 0.8rem;
     }
     .actions a {
       margin-right: 0.5rem;
       /* padding: 0.2rem 0.2rem; */
     }
     .lnk_lbl {
       margin-left: 1.0rem;
       margin-right: 0.3rem;
     }
    </style>
    <link href="/static/datatables.min.css" rel="stylesheet">
  </head>

  <body>
    <dialog class="err_dlg">
      <div></div>
      <button autofocus>Close</button>
    </dialog>
    <div class="container">
      <div class="section">
        {% with tooltip = "Click here to go to current stage" %}
        <span class="tourn_lbl" title='{{tooltip}}'>{{tourn.name}}</span>
        {% endwith %}
        <span class="view_sel">
          View:
          {% for view, info in view_defs.items() %}
          {% set checked = " checked" if view == view_path else "" %}
          <label>{{info.name}}<input type="radio" name="view" value="{{view}}"{{checked}}></label>
          {% endfor %}
        </span>
        <span class="login_info">
          {% with tooltip = "Click here to enter admin mode" %}
          Logged in as: <span title='{{tooltip}}'>{{user.name}}</span>
          [<a href='/logout'>Logout</a>]
          {% endwith %}
        </span>
        <div class="subsect info_blk">
          <input name="tourn_name" type="hidden" value="{{tourn.name}}">
          <span>Players:<input name="players" type="number" value="{{tourn.players}}" disabled></span>
          <span>Teams:<input name="teams" type="number" value="{{tourn.teams}}" disabled></span>
          <span>THM Teams:<input name="thm_teams" type="number" value="{{tourn.thm_teams}}" disabled></span>
        </div>
        <div class="subsect stage_blk">
          <span>Current Stage:<input name="cur_stage" type="text" value="{{tourn.cur_stage}}" disabled></span>
          <span>Next:<input name="next_action" type="text" value="{{tourn.next_action if tourn.next_action else ''}}" disabled></span>
        </div>
      </div>

      <div class="section tbl_wrapper">
        {% with tooltip = "Click here to refresh table data" %}
        <span class="view_title" title='{{tooltip}}'>{{view_info.name}}</span>
        {% endwith %}
        <table id="view_dt" class="display" spellcheck="false">
          <thead>
            <tr>
              {% for col in view_info.layout %}
              <th>{{col[1]}}</th>
              {% endfor %}
            </tr>
          </thead>
        </table>
        <div class="subsection actions">
          <form action="{{view_path}}" method="post">
            {% for val in buttons %}
            <button value="{{val}}"{{btn_attr[loop.index0]}}>{{btn_lbl[loop.index0]}}</button>
            {% endfor %}
            {% if links %}
            <a class="demo_data" href="javascript:void(0);">[demo data]</a>
            <span class="lnk_lbl">Display:</span>
            {% for lnk in links %}
            <a href="#" onclick="window.open('{{lnk[0]}}', '_blank')"">{{lnk[1]}}</a>
            {% endfor %}
            {% endif %}
          </form>
        </div>
      </div>
    </div>
  </body>

  <script src="/static/jquery-3.7.1.min.js"></script>
  <script src="/static/datatables.min.js"></script>
  <script>
   $(function() {
     // add css and attributes
     $(".actions button").attr({
       type: 'submit',
       name: "submit_func"
     });

     // error dialog
     $('.err_dlg button').on('click', function() {
       $('.err_dlg')[0].close();
     });
     const show_error = function(err_text) {
       $('.err_dlg div').html(err_text);
       $('.err_dlg')[0].showModal();
     };

     // view selection
     $(".view_sel input").on('change', function() {
       const path = $(".view_sel input:checked").val();
       window.location.href = path;
     });

     // shortcuts (navigation)
     $(".tourn_lbl").on('click', function() {
       window.location.href = './';
     });
     $('.view_title').on('click', function() {
       // FIX: only need to refresh table data!!!
       window.location.href = "";
     });
     $('.login_info span').on('click', function() {
       window.location.href = "/tourn";
     });

     // view stuff
     const editable = function(node) {
       let orig_val;

       node.setAttribute('contenteditable', true);
       node.addEventListener('keypress', function(e) {
         if (e.which == 13) {
           e.preventDefault();
           $(this).trigger('blur');
           $(this).next('td').focus();
           //return false;
         }
       });

       node.addEventListener('focus', function(e) {
         orig_val = e.target.textContent;
         $('td[contenteditable].attn').removeClass("attn");
         window.getSelection().selectAllChildren(e.target);
       });

       node.addEventListener('blur', function(e) {
         window.getSelection().empty();
         if (e.target.textContent !== orig_val) {
           const cell = table.cell(e.target)
           const row = table.row(e.target.parentElement);
           cell.data(e.target.textContent).draw();

           const post_data = $.extend({tourn: "{{tourn.name}}"}, row.data());
           $.post('/data{{view_path}}', post_data)
            .done(function(resp) {
              console.log('POST /data{{view_path}} done: ', resp);
              if (resp.err) {
                cell.data(orig_val).draw();
                $(e.target).addClass("attn");
                show_error(resp.err);
              }
              else if (resp.succ) {
                if (resp.data == 'all') {
                  console.log('Reloading table data');
                  table.ajax.reload();
                }
                else if (resp.data) {
                  console.log('Updating row data: ', resp.data);
                  row.data(resp.data).draw();
                }
              }
            })
            .fail(function(resp) {
              console.log('POST /data{{view_path}} fail: ', resp);
              cell.data(orig_val).draw();
              $(e.target).addClass("attn");
              show_error(resp.statusText);
              win = window.open('', '_blank')
              win.document.body.innerHTML = resp.responseText;
            });
       }});
     };

     const tourn = $('.info_blk input[name="tourn_name"]').val();
     const table = $('#view_dt').DataTable({
       rowId: '{{view_info.rowid_col}}',
       paging: false,
       scrollX: true,
       scrollY: '35rem',
       //fixedColumns: {
       //  start: {{view_info.fixed_cols}}
       //},
       columnControl: {
         target: 1,
         content: ['search']
       },
       ajax: {
         url: '/data{{view_path}}',
         dataSrc: 'data'
       },
       deferRender: true,
       columns: [
         {% for col in view_info.layout %}
         {data: '{{col[0]}}'},
         {% endfor %}
       ],
       columnDefs: [
         {% for col in view_info.layout %}
         {% if col[2] == 'hidden' %}
         {target: {{loop.index0}}, visible: false, searchable: false},
         {% elif col[2] == 'centered' %}
         {target: {{loop.index0}}, className: 'dt-center'},
         {% elif col[2] == 'editable' %}
         {target: {{loop.index0}}, createdCell: editable},
         {% else %}
         {target: {{loop.index0}}},
         {% endif %}
         {% endfor %}
       ],
       order: [[{{view_info.tbl_order}}, 'asc']],
       initComplete: function(settings, json) {
         $(".tbl_wrapper").css('display', 'block');
         table.columns.adjust().draw();
       }
     });

     let popupWin;
     $('a.demo_data').on('click', function(e) {
       if (popupWin && !popupWin.closed) {
         popupWin.close();
       }
       const specs = "popup,width=375,height=215,top=200,left=200";
       popupWin = window.open('/demo/', "_blank", specs);
     });

     // TODO: set initial focus (and/or highlight) here!!!

     {% if err_msg %}
     show_error('{{err_msg|safe}}');
     {% endif %}
   });
  </script>
</html>
