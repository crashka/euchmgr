<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>

    <style>
     html {
       font-size: 16px;
       font-size: 3.9vmin;
       /*font-size: calc(1.2vh + 1.2vw);*/
     }
     .err_dlg {
       width: 75%;
       max-width: 20rem;
       padding: 1.1rem 1.4rem;
     }
     .err_dlg div {
       color: #D10000;
       overflow: auto;
     }
     .err_dlg button {
       margin-top: 1.2rem;
     }
     .login_info {
       float: right;
       margin-top: 0.0rem;
       font-size: 0.812rem;
       text-align: right;
     }
     .login_info span {
       font-weight: normal;
     }
     .info {
       display: flex;
       flex-flow: row wrap;
       width: 100%;
     }
     .info p {
       min-width: 45%;
       justify-content: space-around;
       margin: 0.35rem 0.25rem;
     }
     .info span {
       background-color: #F0F0F0;
       display: inline-block;
       min-width: 2rem;
       margin-left: 0.1rem;
       padding: 0.0rem 0.5rem 0.05rem 0.3rem;
     }
     .cur_game h2 {
       display: inline-block;
     }
     .cur_game > p {
       margin: 0.35rem 0.25rem;
     }
     .round {
       font-size: 1.0rem;
       margin-left: 0.3rem;
     }
     .matchup {
       text-align: center;
       display: inline-block;
       min-width: 14rem;
       margin: 0.3rem 0.0rem 0.5rem 0.0rem;
     }
     .score {
       display: inline-block;
       margin: 0.3rem 0.0rem 0.5rem 1.0rem;
     }
     .score label {
       margin-left: 0.3rem;
     }
     .score select {
       text-align: center;
       width: 2.7rem;
     }
     .score span {
       display: inline-block;
       background-color: #F0F0F0;
       text-align: center;
       min-width: 2rem;
     }
     .units {
       display: inline-block;
       margin: 0.3rem 0.0rem 0.5rem 0.0rem;
     }
     .units label {
       margin-left: 0.3rem;
     }
     .cur_game button + button[value="correct_score"] {
       display: none;  /* only if stacked behind another button */
     }
     .reset {
       font-size: 0.813rem;
       margin-left: 0.35rem;
     }
     .reset:not([href]) {
       color: #A9A9A9;
     }
     .actions {
       margin: 0.5rem 0.0rem;
     }
     span.med {
       min-width: 4.5rem;
     }
     span.wide {
       min-width: 9rem;
     }
     .winner {
       color: #108810;
     }
     .loser {
       color: #D70000;
     }
     h1 {
       font-size: 1.5rem;
     }
     h2 {
       font-size: 1.375rem;
       margin-bottom: 0.0rem;
     }
     h3 {
       font-size: 1.25rem;
       margin-top: 0.5rem;
       margin-bottom: 0.3rem;
     }
     h4 {
       font-size: 1.0rem;
       margin-top: 0.5rem;
       margin-bottom: 0.0rem;
     }
     button {
       padding: 0.1rem 0.2rem;
     }
     b {
       font-weight: bold;
       /*color: {{bold_color or "black"}};*/
     }
     u {
       text-decoration: none;
     }
    </style>
  </head>

  <body>
    <dialog class="err_dlg">
      <div></div>
      <button autofocus>Close</button>
    </dialog>
    <p class="login_info">
      Logged in as: <span>{{user.nick_name}}</span> [<a href='/logout'>Logout</a>]
    </p>
    <section class="info_stats" id="info-stats">
      <h2>Info/Stats</h2>
      <section class="info">
        {% for info in info_flds %}
        {% if tourn.stage_compl >= info.min_stg %}
        <p>
          {# NOT that an info_data value of `0` must be passed in as a string #}
          <label>{{info.label}}</label>: <span class="{{info.cls}}">{{(info_data[loop.index0] or "&nbsp;")|safe}}</span>
        </p>
        {% endif %}
        {% endfor %}
      </section>
    </section>
    <section class="cur_game" id="cur-game">
      {% set tooltip = "Tap here to reload game info" %}
      <h2 title="{{tooltip}}">Current Game</h2>
      {% if cur_game %}
      <span class="round" title="{{tooltip}}">(Round {{cur_game.round_num}})</span>
      <form action="/mobile" method="post">
        <input type="hidden" name="game_label" value="{{cur_game.label}}">
        <input type="hidden" name="posted_by_num" value="{{user.player_num}}">
        <input type="hidden" name="team_idx" value="{{team_idx}}">
        <input type="hidden" name="ref_score_id" value="{{ref_score_id}}">
        <p class="matchup" title="{{tooltip}}">
          {{team_tag|safe}}
          <br>vs.<br>
          {{opp_tag|safe}}
        </p>
        <p class="score">
          <select name="team_pts">
            {% if team_pts == none %}
            <option value="" selected disabled hidden></option>
            {% endif %}
            {% for pts in range(0, 11) %}
            {% set selected = (" selected" if pts == team_pts else "") %}
            <option{{selected}}>{{pts}}</option>
            {% endfor %}
          </select>
          <label>pts</label>
          <br><br>
          <select name="opp_pts">
            {% if opp_pts == none %}
            <option value="" selected disabled hidden></option>
            {% endif %}
            {% for pts in range(0, 11) %}
            {% set selected = (" selected" if pts == opp_pts else "") %}
            <option{{selected}}>{{pts}}</option>
            {% endfor %}
          </select>
          <label>pts</label>
        </p>
        {% if ref_score %}
        {% set self_post = (ref_score.posted_by == user) %}
        {% set team_post = (ref_score.team_idx == team_idx) %}
        <p>
          {% set role = "opponent" if not team_post else ("you" if self_post else "partner") %}
          <label>Score posted by</label>: <span>{{ref_score.posted_by.nick_name}} ({{role}})</span>
        </p>
        <p class="actions">
          {% if team_post %}
          <button value="correct_score" disabled>Correct Score</button>
          {% else %}
          <button value="accept_score">Accept Score</button>
          <button value="correct_score">Correct Score</button>
          {% endif %}
          <a class="reset">[reset]</a>
        </p>
        {% else %}  {# ref_score #}
        <p class="actions">
          <button value="submit_score" disabled>Submit Score</button>
          <a class="reset">[reset]</a>
        </p>
        {% endif %}  {# ref_score #}
      </form>
      {% else %}  {# cur_game #}
      <p>
        <i>None</i>
      </p>
      {% endif %}  {# cur_game #}
    </section>
    <section class="past_games" id="past-games">
      <h2>Past Games</h2>
      <section id="sd-games">
        <h3>Seeding</h3>
        <section class="info">
          {% set win_rec = fmt_rec(user.seed_wins, user.seed_losses) %}
          {% set pts_rec = fmt_rec(user.seed_pts_for, user.seed_pts_against) %}
          <p>
            <label>W-L (stage)</label>: <span>{{win_rec}}</span>
          </p>
          <p>
            <label>PF-PA (stage)</label>: <span>{{pts_rec}}</span>
          </p>
        </section>
        {% for gm in seed_games %}
        <article id="{{gm.label}}">
          <h4>Round {{gm.round_num}}</h4>
          {% set matchup_str = fmt_matchup(gm, user) %}
          <p class="matchup">
            {{matchup_str[0]|safe}}
          </p>
          <p class="score">
            {{matchup_str[1]|safe}}
          </p>
          <p class="units">
            {{matchup_str[2]|safe}}
          </p>
        </article>
        {% endfor %}
      </section>
      <section id="rr-games">
        <h3>Round Robin</h3>
        <section class="info">
          {% set win_rec = fmt_rec(team.tourn_wins, team.tourn_losses) %}
          {% set pts_rec = fmt_rec(team.tourn_pts_for, team.tourn_pts_against) %}
          <p>
            <label>W-L (stage)</label>: <span>{{win_rec}}</span>
          </p>
          <p>
            <label>PF-PA (stage)</label>: <span>{{pts_rec}}</span>
          </p>
        </section>
        {% for gm in tourn_games %}
        <article id="{{gm.label}}">
          <h4>Round {{gm.round_num}}</h4>
          {% set matchup_str = fmt_matchup(gm, team) %}
          <p class="matchup">
            {{matchup_str[0]|safe}}
          </p>
          <p class="score">
            {{matchup_str[1]|safe}}
          </p>
          <p class="units">
            {{matchup_str[2]|safe}}
          </p>
        </article>
        {% endfor %}
      </section>
      <section id="sf-games">
        <h3>Semifinals</h3>
        <p>
        </p>
      </section>
      <section id="fn-games">
        <h3>Finals</h3>
        <p>
        </p>
      </section>
    </section>
  </body>

  <script src="/static/jquery-3.7.1.min.js"></script>
  <script>
   $(function() {
     // add css and attributes
     $('.actions button').attr({
       type: 'submit',
       name: "action"
     });

     // error dialog
     $('.err_dlg button').on('click', function() {
       this.parentElement.close();
     });
     const showError = function(err_text) {
       const target = $('.err_dlg div')[0];
       target.innerText = err_text;
       target.parentElement.showModal();
     };

     {% if cur_game %}
     // score change
     const chgMap = new Map();
     const ptsMap = new Map();
     const winMap = new Map();
     const updMaps = function(target, isInit = false) {
       if (!isInit) {
         chgMap.set(target.name, true);
       }
       target.value != "" ? ptsMap.set(target.name, target.value) : false;
       target.value == "10" ? winMap.set(target.name, true) : winMap.delete(target.name);
     };
     $('.score select').each(function(idx) {
       updMaps(this, true);
     });
     $('.score select').on('change', function(e) {
       updMaps(this);
       {% if ref_score %}
       if (winMap.size == 1) {
         $('button[value="accept_score"]').css('display', 'none');
         $('button[value="correct_score"]').css('display', 'inline-block')
                                           .prop('disabled', false);
       }
       else {
         $('button[value="correct_score"]').prop('disabled', true);
       }
       {% else %}
       if (ptsMap.size == 2 && winMap.size == 1) {
         $('button[value="submit_score"]').prop('disabled', false);
       }
       else {
         $('button[value="submit_score"]').prop('disabled', true);
       }
       {% endif %}
       $('a.reset').css('display', 'inline')
                   .attr('href', '');
     });
     // refresh score (ignore inputs, links, etc.)
     $('.cur_game').on('click', function(e) {
       if (chgMap.size == 0) {
         // REVISIT: would like to jump down to the game if score has been accepted, but
         // need to figure out why this approach (either variant below) doesn't actually
         // reload the page!!!
         //const url = window.location.origin + window.location.pathname;
         //const anchor = $('.cur_game input[name="game_label"]').attr('value');
         //window.location.href = url + '#' + anchor;
         //window.location.replace(url + '#' + anchor);
         window.location.href = "";
       }
       else {
         showError("Cannot tap to reload game info if there are pending changes");
       }
     });
     $('select, option, button, a', '.cur_game').on('click', function(e) {
       //console.log("trapping click to refresh (clickable element: " + this.nodeName + ")");
       e.stopPropagation();
     });
     {% endif %}

     {% if err_msg %}
     showError("{{err_msg|safe}}");
     {% endif %}
   });
  </script>
</html>
