<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>

    <style>
     html {
       font-size: 15px;
       font-size: 3.9vmin;
       /*font-size: calc(1.2vh + 1.2vw);*/
       /*scroll-padding-top: 2.8rem;*/
     }
     body {
       margin-top: 0.0rem;
       margin-right: 0.5rem;
     }
     .err_dlg {
       width: 75%;
       max-width: 20rem;
       padding: 1.1rem 1.4rem;
     }
     .err_dlg div {
       color: #D10000;
       overflow: auto;
     }
     .err_dlg button {
       margin-top: 1.2rem;
     }
     .header {
       overflow: visible;
       position: sticky;
       top: 0;
       width: 100%;
       font-size: 0.875rem;
       margin: 0.0rem 0.0rem;
       padding: 0.2rem 0.0rem;
       background: rgb(255 255 255 / 1);
     }
     .header .goto {
       display: inline-block;
       padding: 0.5rem 0.0rem;
     }
     .header .nav {
       display: inline-block;
       text-align: center;
       padding: 0.5rem 0.2rem;
     }
     .header .view_nav {
       margin-left: 0.25rem;
     }
     .header .nav:hover,
     .header .nav2:hover {
       background: #E8E8E8;
     }
     .header .nav2 {
       display: block;
       text-align: left;
       padding: 0.8rem 1.3rem 0.8rem 0.3rem;
     }
     .wrapper {
       display: inline-block;
       position: absolute;
     }
     .view_menu {
       position: absolute;
       visibility: hidden;
       width: max-content;
       background: rgb(232 232 232 / 1);
       padding: 0.3rem;
     }
     .login_info {
       float: right;
       text-align: right;
       /*margin-right: 1.0rem;*/
       padding: 0.5rem 0.0rem;
     }
     .login_info span {
       font-weight: bolder;
       color: mediumblue;
       cursor: pointer;
     }
     .info_stats {
       cursor: pointer;
     }
     .info {
       display: flex;
       flex-flow: row wrap;
       width: 100%;
       margin-bottom: 0.3rem;
     }
     .info p {
       min-width: 35%;
       justify-content: space-around;
       margin: 0.35rem 0.25rem;
     }
     .info p.med {
       min-width: 45%;
     }
     .info p.wide {
       min-width: 95%;
     }
     .info span {
       background-color: #F0F0F0;
       display: inline-block;
       min-width: 2.0rem;
       margin-left: 0.1rem;
       padding: 0.0rem 0.5rem 0.05rem 0.3rem;
     }
     .info span.med {
       min-width: 4.5rem;
     }
     .info span.wide {
       min-width: 9rem;
     }
     .register input,
     .register select {
       margin-left: 0.1rem;
       padding: 0.0rem 0.5rem 0.05rem 0.3rem;
     }
     .round {
       font-size: 1.0rem;
       margin-left: 0.3rem;
     }
     .matchup {
       text-align: center;
       display: inline-block;
       min-width: 14rem;
       margin: 0.3rem 0.0rem 0.5rem 0.0rem;
     }
     .score {
       display: inline-block;
       margin: 0.3rem 0.0rem 0.5rem 1.0rem;
     }
     .score label {
       margin-left: 0.3rem;
     }
     .score select {
       text-align: center;
       width: 2.9rem;
     }
     .score span {
       display: inline-block;
       background-color: #F0F0F0;
       text-align: center;
       min-width: 2.3rem;
     }
     .units {
       display: inline-block;
       margin: 0.3rem 0.0rem 0.5rem 0.0rem;
     }
     .units label {
       margin-left: 0.3rem;
     }
     .picks span {
       display: inline-block;
       vertical-align: middle;
     }
     .picks_hdr {
       padding: 0.0rem 0.4rem 0.25rem 0.4rem;
     }
     .picks_hdr span {
       font-weight: bolder;
       text-decoration: solid underline 1px;
     }
     .pick {
       width: max-content;
       padding: 0.35rem 0.4rem 0.45rem 0.4rem;
       border-bottom: 1px solid grey;
     }
     .pick form {
       display: inline-block;
     }
     .picker {
       min-width: 9.0rem;
     }
     .partner {
       min-width: 9.0rem;
       margin-left: 2.0rem;
     }
     .partner select {
       width: 9.0rem;
     }
     .empty {
       background-color: #F0F0F0;
     }
     .actions button + button[value="correct_score"] {
       display: none;  /* only if stacked behind another button */
     }
     .reset {
       font-size: 0.813rem;
       margin-left: 0.35rem;
     }
     .reset:not([href]) {
       color: #A9A9A9;
     }
     .actions {
       display: inline-block;
       margin: 0.5rem 0.0rem;
     }
     .picks .actions {
       display: block;
       margin: 0.7rem 0.0rem 0.5rem 0.0rem;
     }
     .games h3 {
       display: inline-block;
       padding-bottom: 0.5rem;
       cursor: pointer;
     }
     .leaderboard h3 {
       display: inline-block;
       cursor: pointer;
     }
     .games > span,
     .leaderboard > span {
       display: inline-block;
       font-style: italic;
       margin-left: 0.6rem;
       cursor: pointer;
     }
     .games article {
       padding: 0.2rem 0.4rem;
       border-top: 1px solid grey;
     }
     .games article:last-child {
       border-bottom: 1px solid grey;
     }
     .game.active,
     .pick.active {
       cursor: pointer;
     }
     .lb_hdr {
       margin: 0.0rem 0.0rem;
     }
     .lb_hdr span {
       /*text-decoration: solid underline 1px;*/
       border-bottom: 1px solid grey;
     }
     .leaderboard {
       display: none;
     }
     .leaderboard span:first-child {
       display:inline-block;
       min-width: 12.0rem;
       margin-right: 0.3rem;
     }
     .leaderboard span + span {
       display:inline-block;
       text-align: center;
       min-width: 2.7rem;
       margin: 0.0rem 0.3rem;
     }
     .winner {
       color: #108810;
     }
     .loser {
       color: #D70000;
     }
     .pending {
       color: #6F6F6F;
     }
     .active {
       background-color: #FFF8F0;
     }
     .leaderboard .active {
       font-weight: bolder;
       background-color: #FFF8F0;
     }
     h1 {
       font-size: 1.5rem;
     }
     h2 {
       font-size: 1.375rem;
       margin-top: 0.0rem;
       margin-bottom: 0.5rem;
     }
     h3 {
       font-size: 1.125rem;
       margin-top: 0.5rem;
       margin-bottom: 0.5rem;
     }
     h4 {
       font-size: 1.0rem;
       margin-top: 0.25rem;
       margin-bottom: 0.0rem;
     }
     button {
       padding: 0.1rem 0.2rem;
     }
     b {
       font-weight: bold;
     }
     u {
       text-decoration: none;
     }
     .resources {
       margin-top: 1.0rem;
       font-size: normal;
     }
     .resources h3 {
       display: inline-block;
       margin-bottom: 0.8rem;
     }
     .resources span {
       font-style: italic;
       margin-left: 0.2rem;
     }
     .resources ul {
       list-style-type: none;
       padding: 0.0rem;
       margin: 0.0rem;
     }
     .resources li + li {
       margin: 1.0rem 0.0rem;
     }
    </style>
  </head>

  <body>
    <dialog class="err_dlg">
      <div></div>
      <button autofocus>Close</button>
    </dialog>
    <div class="header">
      <span class="goto">Go to:</span>
      <a class="nav" href="./">Current</a>
      <div class="wrapper">
        <a class="nav view_nav" href="javascript:void(0);">Stage</a>
        <div class="view_menu">
          {% for href, label in view_menu %}
          <a class="nav2" href="{{href}}">{{label|safe}}</a>
          {% endfor %}
        </div>
      </div>
      <span class="login_info">
        {% with tooltip = "Tap here for user admin" %}
        User: <span title='{{tooltip}}'>{{user.name}}</span>
        [<a href='/logout'>Logout</a>]
        {% endwith %}
      </span>
    </div>
    {% with tooltip = "Tap here to refresh view" %}
    <section class="info_stats" id="info-stats" title='{{tooltip}}'>
      <h2>{{view_name}}</h2>
      <section>
        {% for sect, info_flds in info_data.items() %}
        {% if not loop.first %}
        <h3>Stage Info</h3>
        {% endif %}
        <article class="info">
          {% for info in info_flds %}
          {% if tourn.stage_compl >= info.min_stg %}
          <p class="{{info.cls}}">
            {# NOTE that an info_data value of `0` must be passed in as a string #}
            {% set data_val = info.value or "&nbsp;" %}
            {% set colon = "" if info.label[-1] == "?" else ":" %}
            <label>{{info.label}}</label>{{colon}}
            <span class="{{info.cls}}">{{data_val|safe}}</span>
          </p>
          {% endif %}
          {% endfor %}
        </article>
        {% endfor %}
      </section>
    </section>
    {% endwith %}

    {% set view_active = false %}

    {% if view == View.REGISTER %}
    {% set view_active = true %}
    {% set locked = (nums_avail == none) %}
    {% set disabled = " disabled" if locked else "" %}
    <section class="register" id="register">
      <h3>Player Info</h3>
      <form action="{{view}}" method="post">
        <input type="hidden" name="player_id" value="{{user.id}}">
        <p>
          <label>Nick Name</label>:
          {% set nick_name =  user.nick_name if user.nick_name != user.last_name else "" %}
          <input type="text" name="nick_name" value="{{nick_name}}"{{disabled}}>
        </p>
        <p>
          <label>Player Num</label><sup>&dagger;</sup>:
          <select name="player_num"{{disabled}}>
            {% if nums_avail %}
            <option value="" selected disabled hidden></option>
            {% for num in nums_avail %}
            {% set selected = (" selected" if num == user.player_num else "") %}
            <option{{selected}}>{{num}}</option>
            {% endfor %}
            {% else %}
            <option{{selected}}>{{user.player_num}}</option>
            {% endif %}
          </select>
        </p>
        {% if not locked %}
        <p class="actions">
          <button value="register_player" disabled>Complete Registration</button>
          <a class="reset">[reset]</a>
        </p>
        {% endif %}
      </form>
      <p>
        <sup>&dagger;</sup> (ping pong ball number)
      </p>
    </section>
    {% endif %}  {# view == View.REGISTER #}

    {% if view in (View.SEEDING, View.ROUND_ROBIN, View.SEMIFINALS, View.FINALS) %}
    {% set stage_ent = user if view == View.SEEDING else team %}
    <section class="games" id="sd-games">
      {% if stage_games %}
      {% set view_active = true %}
      <h3>Games</h3><span>(tap here for Leaderboard)</span>
      <form action="{{view}}" method="post">
        <input type="hidden" name="game_label" value="{{cur_game.label}}">
        <input type="hidden" name="posted_by_num" value="{{user.player_num}}">
        <input type="hidden" name="team_idx" value="{{team_idx}}">
        <input type="hidden" name="ref_score_id" value="{{ref_score_id}}">
        {% set gm_lbl = "Game" if view in (View.SEMIFINALS, View.FINALS) else "Round" %}
        {% for gm in stage_games %}
        {% set gm_cls = " active" if gm == cur_game else ("" if gm.winner else " pending") %}
        <article class="game{{gm_cls}}" id="{{gm.label}}">
          <h4>{{gm_lbl}} {{gm.round_num}}</h4>
          {% set matchup_str = fmt_matchup(gm, stage_ent) %}
          <p class="matchup">
            {{matchup_str[0]|safe}}
          </p>
          <p class="score">
            {% if gm == cur_game and not gm.winner %}
            <select name="team_pts">
              {% if team_pts == none %}
              <option value="" selected disabled hidden></option>
              {% endif %}
              {% for pts in range(0, 11) %}
              {% set selected = (" selected" if pts == team_pts else "") %}
              <option{{selected}}>{{pts}}</option>
              {% endfor %}
            </select>
            <br><br>
            <select name="opp_pts">
              {% if opp_pts == none %}
              <option value="" selected disabled hidden></option>
              {% endif %}
              {% for pts in range(0, 11) %}
              {% set selected = (" selected" if pts == opp_pts else "") %}
              <option{{selected}}>{{pts}}</option>
              {% endfor %}
            </select>
            {% else %}
            {{matchup_str[1]|safe}}
            {% endif %}
          </p>
          <p class="units">
            {{matchup_str[2]|safe}}
          </p>
          {% if gm == cur_game %}
          {% if ref_score %}
          {% set self_post = (ref_score.posted_by == user) %}
          {% set team_post = (ref_score.team_idx == team_idx) %}
          <p>
            {% set action = "accepted" if ref_score.post_action == "accept" else "posted" %}
            {% set role = "opponent" if not team_post else ("you" if self_post else "partner") %}
            <label>Score {{action}} by</label>:
            <span>{{ref_score.posted_by.name}} ({{role}})</span>
          </p>
          {% if not gm.winner %}
          <p class="actions">
            {% if team_post %}
            <button value="correct_score" disabled>Correct Score</button>
            {% else %}
            <button value="accept_score">Accept Score</button>
            <button value="correct_score">Correct Score</button>
            {% endif %}
            <a class="reset">[reset]</a>
          </p>
          {% endif %}  {# not gm.winner #}
          {% else %}  {# ref_score #}
          <p class="actions">
            <button value="submit_score" disabled>Submit Score</button>
            <a class="reset">[reset]</a>
          </p>
          {% endif %}  {# ref_score #}
          {% endif %}  {# gm == cur_game #}
        </article>
        {% endfor %}
      </form>
      {% else %}  {# stage_games #}
      <p>
        {% set plural = "s" if view == View.ROUND_ROBIN else "" %}
        <i>Bracket{{plural}} not yet created</i>
      </p>
      {% endif %}  {# stage_games #}
    </section>

    {% if leaderboard %}
    <section class="leaderboard">
      <h3>Leaderboard</h3><span>(tap here for Games)</span>
      {% set lb_hdr, lb_data = leaderboard  %}
      <p class="lb_hdr">
        <span>{{lb_hdr[1]}}</span>
        <span>{{lb_hdr[2]}}</span>
        <span>{{lb_hdr[3]}}</span>
        <span>{{lb_hdr[4]}}</span>
      </p>
      {% for pos in lb_data %}
      {% set pos_cls = "active" if stage_ent.id == pos[0] else "" %}
      <p class="{{pos_cls}}">
        <span>{{pos[1]|safe}}</span>
        <span>{{pos[2]|safe}}</span>
        <span>{{pos[3]|safe}}</span>
        <span>{{pos[4]|safe}}</span>
      </p>
      {% endfor %}
    </section>
    {% endif %}  {# leaderboard #}
    {% endif %}  {# view in (View.SEEDING, View.ROUND_ROBIN, View.SEMIFINALS, View.FINALS) #}

    {% if view == View.PARTNERS %}
    <section class="picks" id="pt-picks">
      {% if partner_picks %}
      {% set view_active = true %}
      <h3>Picking Order</h3>
      <article class="picks_hdr">
        <span class="picker">Player (by rank)</span>
        <span class="partner">Teammate(s)</span>
      </article>
      <form action="{{view}}" method="post">
        {% for pk in partner_picks %}
        {% set pk_cls = " active" if pk == cur_pick else ("" if pk.partner else " pending") %}
        <article class="pick{{pk_cls}}" id="pk-{{pk.player_rank}}">
          {% set is_you = " &ndash; <i>you</i>" if pk == user else "" %}
          {% set champ_flg = "*" if pk.reigning_champ else "" %}
          <span class="picker">{{pk.seed_ident}}{{is_you|safe}}{{champ_flg}}</span>
          {% if pk == user and cur_pick == user %}
          <input type="hidden" name="player_num" value="{{user.player_num}}">
          <span class="partner">
            <select name="partner_num">
              <option value="" selected disabled hidden></option>
              {% for pt in picks_avail %}
              <option value="{{pt.player_num}}">{{pt.seed_ident}}</option>
              {% endfor %}
            </select>
          </span>
          <p class="actions">
            <button value="pick_partner" disabled>Submit Pick</button>
            <a class="reset">[reset]</a>
          </p>
          {% else %}  {# pk == user #}
          {% if pk.partner %}
          <span class="partner">{{pk.picks_info2|safe}}</span>
          {% else %}
          <span class="partner empty">&nbsp;</span>
          {% endif %}
          {% endif %}  {# pk == user #}
        </article>
        {% endfor %}
      </form>
      <p>
        <i>* indicates reigning champ</i>
      </p>
      {% else %}  {# partner_picks #}
      <p>
        <i>Partner pick order not yet determined</i>
      </p>
      {% endif %}  {# partner_picks #}
    </section>
    {% endif %}  {# view == View.PARTNERS #}

    {% if resources and view_active %}
    <section class="resources">
      <h3>Resources</h3>
      <span>(not mobile friendly)</span>
      <ul>
        {% for rsrc in resources %}
        <li><a href="{{rsrc[0]}}" target='_blank'>{{rsrc[1]}}</a></li>
        {% endfor %}
      </ul>
    </section>
    {% endif %}  {# resources #}
  </body>

  <script src="/static/jquery-3.7.1.min.js"></script>
  <script>
   $(function() {
     // add css and attributes
     $('.actions button')
       .attr({
         type: 'submit',
         name: "action"
       })
       .attr('formaction', function() {
         const baseAction = $(this).closest('form').attr('action')
         return baseAction + '/' + $(this).attr('value');
       });

     // error dialog
     $('.err_dlg button').on('click', function() {
       this.parentElement.close();
     });
     const showError = function(err_text) {
       const target = $('.err_dlg div')[0];
       target.innerHTML = err_text;
       target.parentElement.showModal();
     };

     // menu/navigation stuff
     $('.view_nav').on('focus', function() {
       setTimeout(function() {
         $('.view_menu').css('visibility', 'visible');
       }, 0);
     });
     $('.view_nav').on('focusout', function() {
       setTimeout(function() {
         $('.view_menu').css('visibility', 'hidden');
       }, 0);
     });
     $('.view_nav').on('click', function() {
       const menuVis = $('.view_menu').css('visibility');
       const hasFocus = $(this).is(":focus");
       if (menuVis == 'visible') {
         $(this).trigger('blur');
       }
       else if (!hasFocus) {
         $(this).trigger('focus');
       }
     });
     // shortcuts
     $('.info_stats').on('click', function() {
       window.location.href = "";
     });
     $('.login_info span').on('click', function() {
       window.location.href = "./register";
     });

     {% if cur_game %}
     // score change
     const chgMap = new Map();
     const ptsMap = new Map();
     const winMap = new Map();
     const updMaps = function(target, isInit = false) {
       if (!isInit) {
         chgMap.set(target.name, true);
       }
       target.value != "" ? ptsMap.set(target.name, target.value) : false;
       target.value == "10" ? winMap.set(target.name, true) : winMap.delete(target.name);
     };
     $('.score select').each(function(idx) {
       updMaps(this, true);
     });
     $('.score select').on('change', function() {
       updMaps(this);
       {% if ref_score %}
       if (winMap.size == 1) {
         $('button[value="accept_score"]').css('display', 'none');
         $('button[value="correct_score"]').css('display', 'inline-block')
                                           .prop('disabled', false);
       }
       else {
         $('button[value="correct_score"]').prop('disabled', true);
       }
       {% else %}
       if (ptsMap.size == 2 && winMap.size == 1) {
         $('button[value="submit_score"]').prop('disabled', false);
       }
       else {
         $('button[value="submit_score"]').prop('disabled', true);
       }
       {% endif %}
       $('a.reset').attr('href', '');
     });
     // refresh score for current game (disregarding clickable elements)--note that the
     // current game may change on this reload
     $('.game.active').on('click', function(e) {
       if (chgMap.size == 0) {
         //window.location.href = window.location.pathname;
         //window.location.href = '';
         // WATCH: this appears to reload changed data despite all of the claims that the
         // `forceGet` flag is ignored these days; if we see that this is not reliable, we
         // can fall back to setting location.href (I think the two commented out options,
         // just above, are equivalent)!
         window.location.reload(true);
       }
       else {
         showError("Cannot tap to reload game info if there are pending changes");
       }
     });
     $('select, option, button, a', '.game').on('click', function(e) {
       //console.log("trapping click to refresh (clickable element: " + this.nodeName + ")");
       e.stopPropagation();
     });
     {% endif %}  {# cur_game #}

     {% if stage_games %}
     $('.games h3, .games > span').on('click', function() {
       setTimeout(function() {
         $('.games').css('display', 'none');
       }, 0);
       $('.leaderboard').css('display', 'block');
     });
     $('.leaderboard h3, .leaderboard > span').on('click', function() {
       setTimeout(function() {
         $('.leaderboard').css('display', 'none');
       }, 0);
       $('.games').css('display', 'block');
     });
     {% endif %}

     {% if partner_picks %}
     $('.partner select').on('change', function() {
       $('button[value="pick_partner"]').prop('disabled', false);
       $('a.reset').attr('href', '');
     });
     $('.pick.active').on('click', function(e) {
       // see comment for '.game.active' above
       window.location.reload(true);
     });
     $('select, option, button, a', '.pick').on('click', function(e) {
       //console.log("trapping click to refresh (clickable element: " + this.nodeName + ")");
       e.stopPropagation();
     });
     {% endif %}  {# partner_picks #}

     {% if nums_avail %}
     $('.register input').on('keydown', function() {
       $('button[value="register_player"]').prop('disabled', false);
       $('a.reset').attr('href', '');
     });
     $('.register select').on('change', function() {
       $('button[value="register_player"]').prop('disabled', false);
       $('a.reset').attr('href', '');
     });
     {% endif %}  {# partner_picks #}

     {% if err_msg %}
     showError("{{err_msg|safe}}");
     {% endif %}
   });
  </script>
</html>
