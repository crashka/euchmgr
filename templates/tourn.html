<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>

    <style>
     body {
       width: max-content;
       min-width: 45rem;
     }
     header {
       padding: 0.80rem 0.0rem;
     }
     h2 {
       margin: 0.5rem 0.0rem;
     }
     .err_blk {
       color: #D10000;
       margin-top: 1.3rem;
       display: none;
     }
     form {
       display: inline-block;
     }
     .sel_tourn {
       width: 13.0rem;
       margin-left: 0.3rem;
       padding: 0.2rem 0.1rem;
     }
     .login_info {
       float: right;
       text-align: right;
       padding: 0.10rem 0.0rem;
     }
     .login_info span {
       font-weight: bold;
       color: mediumblue;
       cursor: pointer;
     }
     .tourn form p {
       display: inline-block;
       min-width: 8.0rem;
       margin: 0.4rem 0.0rem;
     }
     .tourn form p.wide {
       display: block;
       margin: 0.8rem 0.0rem;
     }
     .tourn label {
       display: block;
       margin: 0.2rem 0.0rem;
     }
     .tourn label.inline {
       display: inline-block;
       margin-right: 0.3rem;
       vertical-align: middle;
     }
     .tourn input {
       padding: 0.15rem 0.3rem;
     }
     .tourn input[readonly] {
       border: thin solid grey;
       background-color: #F0F0F0;
     }
     .tourn input[type="text"],
     .tourn input[type="password"] {
       width: 13rem;
     }
     .tourn input[type="number"] {
       width: 3rem;
     }
     .tourn input[type="file"] {
       padding: 0.15rem 0.0rem;
       vertical-align: middle;
     }
     .tourn input[type="checkbox"] {
       margin: 0.0rem;
       vertical-align: middle;
     }
     .opts {
       margin-top: 1.5rem;
     }
     .actions {
       display: inline-block;
       margin-top: 1.5rem;
     }
     .actions button {
       margin-right: 0.8rem;
       padding: 0.2rem 0.8rem;
     }
     .actions a {
       margin-right: 0.5rem;
       /* padding: 0.2rem 0.2rem; */
     }
    </style>
  </head>

  <body>
    <header>
      <form action="/tourn/select_tourn" method="post">
        <input type="hidden" name="action" value="select_tourn">
        <label>Select Tournament:</label>
        <select name="tourn" class="sel_tourn" onchange="this.form.submit();">
          {% if new_tourn %}
          {% for tourn_name in tourn_sel %}
          {% set selected = " selected" if tourn_name == sel_new else "" %}
          {% set disabled = " disabled" if tourn_name == sel_sep else "" %}
          <option value="{{tourn_name}}"{{selected}}{{disabled}}>{{tourn_name}}</option>
          {% endfor %}

          {% elif tourn %}
          {% for tourn_name in tourn_sel %}
          {% set selected = " selected" if tourn_name == tourn.name else "" %}
          {% set disabled = " disabled" if tourn_name == sel_sep else "" %}
          <option value="{{tourn_name}}"{{selected}}{{disabled}}>{{tourn_name}}</option>
          {% endfor %}

          {% else %}
          <option value="" disabled selected hidden></option>
          {% for tourn_name in tourn_sel %}
          {% set disabled = " disabled" if tourn_name == sel_sep else "" %}
          <option value="{{tourn_name}}"{{disabled}}>{{tourn_name}}</option>
          {% endfor %}
          {% endif %}
        </select>
      </form>
      <span class="login_info">
        {% with tooltip = "Click here to exit admin mode" %}
        Logged in as: <span title='{{tooltip}}'>{{user.name}}</span>
        [<a href='/logout'>Logout</a>]
        {% endwith %}
      </span>
    </header>
    {% if tourn %}
    <section class="tourn">
      {% set new = "New " if new_tourn else "" %}
      <h2>{{new}}Tournament Info</h2>
      <form action="/tourn" method="post" enctype="multipart/form-data">
        <input type="hidden" name="tourn_id" value="{{tourn.id}}">
        <p class="wide">
          <label>Name:</label>
          {% set hlp_msg = "required (must be unique)" %}
          {% set attrs = "required autofocus" if new_tourn else "readonly" %}
          <input name="tourn_name" type="text" value="{{tourn.name or ''}}"
                 placeholder="{{hlp_msg}}" {{attrs}}>
        </p>
        <p class="wide">
          <label>Dates:</label>
          <input name="dates" type="text" value="{{tourn.dates or ''}}">
        </p>
        <p class="wide">
          <label>Venue:</label>
          <input name="venue" type="text" value="{{tourn.venue or ''}}">
        </p>
        <div>
          <p>
            <label>Rounds (seed):</label>
            <input name="seed_rounds" type="number" value="{{tourn.seed_rounds}}" disabled>
          </p>
          <p>
            <label>Rounds (tourn):</label>
            <input name="tourn_rounds" type="number" value="{{tourn.tourn_rounds}}" disabled>
          </p>
          <p>
            <label>Divisions (tourn):</label>
            <input name="divisions" type="number" value="{{tourn.divisions}}" disabled>
          </p>
        </div>
        {% with tooltip = "Leave empty if player passwords are not required" %}
        <p class="wide" title="{{tooltip}}">
          <label>Default Player Password:</label>
          {% set pw_str = dummy_pw if tourn.dflt_pw_hash else "" %}
          <input name="dflt_pw" type="password" value="{{pw_str}}">
        </p>
        {% endwith %}
        {% if new_tourn %}
        <div class="opts">
          <p class="wide">
            <label class="inline">Roster File:</label>
            <input name="roster_file" type="file" value="" accept=".csv" required>
          </p>
          {% with tooltip = "Delete all data for existing tournament with the same name" %}
          <p class="wide" title="{{tooltip}}">
            <label class="inline">Overwrite Existing:</label>
            {% set checked = " checked" if overwrite else "" %}
            <input type="checkbox" name="overwrite" value="yes"{{checked}}>
          </p>
          {% endwith %}
        </div>
        {% endif %}  {# new_tourn #}
        <div class="actions">
          {% if new_tourn %}
          <button value="{{buttons[1]}}"{{btn_attr[1]}}>{{btn_lbl[1]}}</button>
          <a class="reset" href="javascript:void(0);">[reset]</a>
          {% else %}
          <button value="{{buttons[2]}}"{{btn_attr[2]}}>{{btn_lbl[2]}}</button>
          <button value="{{buttons[3]}}"{{btn_attr[3]}}>{{btn_lbl[3]}}</button>
          <a class="cancel" href="./">[cancel]</a>
          {% endif %}
        </div>
      </form>
    </section>
    {% endif %}  {# tourn #}
    <section class="err_blk">
      <div>
      </div>
    </section>
  </body>

  <script src="/static/jquery-3.7.1.min.js"></script>
  <script>
   $(function() {
     // add css and attributes
     $(".actions button")
       .attr({
         type: 'submit',
         name: "action"
       })
       .attr('formaction', function() {
         const baseAction = $(this).closest('form').attr('action')
         return baseAction + '/' + $(this).attr('value');
       });

     // shortcuts (navigation) and local actions
     $('.login_info span').on('click', function() {
       window.location.href = "./";
     });
     $('a.reset').on('click', function() {
       $('.tourn input:text').val("");
       $('.tourn input:file').val("");
       $('.tourn input:checkbox').prop("checked", false);
       $('.tourn input:password').val("{{pw_str}}");
     });

     // error block
     const show_error = function(err_text) {
       $('.err_blk div').html(err_text);
       $('.err_blk').css('display', 'flex');
     };
     $('body').on('click', function() {
       $('.err_blk').css('display', 'none');
     });

     {% if err_msg %}
     show_error('{{err_msg|safe}}');
     {% endif %}
   });
  </script>
</html>
